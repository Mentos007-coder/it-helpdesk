{% extends "base.html" %}
{% block content %}
<h3 class="mb-4">Dashboard</h3>

<div class="row text-center mb-4 g-3">
  <div class="col-4 col-md-4">
    <div class="card bg-light shadow-sm p-3 rounded-4 hover-up">
      <h6 class="text-muted">Open</h6><h4 class="fw-bold text-primary">{{ open_count }}</h4>
    </div>
  </div>
  <div class="col-4 col-md-4">
    <div class="card bg-warning bg-opacity-25 shadow-sm p-3 rounded-4 hover-up">
      <h6 class="text-muted">In Progress</h6><h4 class="fw-bold text-warning">{{ progress_count }}</h4>
    </div>
  </div>
  <div class="col-4 col-md-4">
    <div class="card bg-success bg-opacity-25 shadow-sm p-3 rounded-4 hover-up">
      <h6 class="text-muted">Closed</h6><h4 class="fw-bold text-success">{{ closed_count }}</h4>
    </div>
  </div>
</div>

<div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
  <div class="input-group mb-2" style="max-width:300px;">
    <input id="searchBox" class="form-control" placeholder="üîç Search tickets...">
  </div>

  <div>
    <button class="btn btn-primary btn-sm rounded-pill" data-bs-toggle="modal" data-bs-target="#ticketModal">+ New Ticket</button>
    {% if user[2] in ['admin','technician'] %}
      <a href="/export/csv" class="btn btn-outline-secondary btn-sm ms-2">‚¨áÔ∏è CSV</a>
      <a href="/export/xlsx" class="btn btn-outline-success btn-sm ms-1">‚¨áÔ∏è Excel</a>
    {% endif %}
  </div>
</div>

<div class="table-responsive">
  <table class="table table-striped align-middle shadow-sm" id="ticketTable">
    <thead class="table-dark text-nowrap">
      <tr>
        <th>ID</th><th>Title</th><th>Status</th><th>Created</th><th>By</th><th>Assigned</th><th>Actions</th>
      </tr>
    </thead>
    <tbody>
    {% for t in tickets %}
      <tr>
        <td>{{ t[0] }}</td>
        <td class="text-wrap">{{ t[1] }}</td>
        <td>{{ t[3] }}</td>
        <td><small>{{ t[4] }}</small></td>
        <td><small>{{ t[5] or '‚Äî' }}</small></td>
        <td><small>{{ t[6] or '‚Äî' }}</small></td>
        <td>
          <select class="form-select form-select-sm status-select" data-id="{{ t[0] }}">
            <option value="Open" {% if t[3]=='Open' %}selected{% endif %}>Open</option>
            <option value="In Progress" {% if t[3]=='In Progress' %}selected{% endif %}>In Progress</option>
            <option value="Closed" {% if t[3]=='Closed' %}selected{% endif %}>Closed</option>
          </select>
          <button class="btn btn-sm btn-outline-success update-status mt-1" data-id="{{ t[0] }}">Update</button>
        </td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
</div>

<div class="card shadow-sm mt-4 p-3">
  <canvas id="ticketChart" height="120"></canvas>
</div>

<!-- New Ticket Modal -->
<div class="modal fade" id="ticketModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4">
      <div class="modal-header">
        <h5 class="modal-title">Create Ticket</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="ticketForm">
          <div class="mb-3">
            <label class="form-label">Title</label>
            <input class="form-control" name="title" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Description</label>
            <textarea class="form-control" name="description" rows="3" required></textarea>
          </div>
          {% if user[2] in ['admin','technician'] %}
          <div class="mb-3">
            <label class="form-label">Assign to</label>
            <select class="form-select" name="assigned_to">
              <option value="">-- none --</option>
              {% for u in users %}
                <option value="{{ u[0] }}">{{ u[1] }}</option>
              {% endfor %}
            </select>
          </div>
          {% endif %}
          <button class="btn btn-success w-100">Create</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}